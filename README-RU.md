# NierWemPatcher
**[EN](https://github.com/GearStarter/NierWemPatcher/blob/main/README.md) | [RU](https://github.com/GearStarter/NierWemPatcher/blob/main/README-RU.md)**

Инструмент для патчинга аудиофайлов формата .wem перед их упаковкой в архивы .wsp для игры NieR: Automata.

## Общие сведения

Основной инструмент для работы с аудиофайлами игры **[NieR-Audio-Tools](https://github.com/NSACloud/NieR-Audio-Tools)**.

Прямая замена файлов .wem приводит к сбоям в работе игры. В результате тщательного анализа, включая побайтовое сравнение в шестнадцатеричном редакторе с использованием **Grok**, были выявлено следующее:

### Основные выводы

1. **Значения байтов на позициях 0x28 и 0x29**:
   - После обработки в Wwise файлы .wem имеют значения `0x28 = 01`, `0x29 = 41`.
   - В оригинальных файлах .wem значения составляют `0x28 = 04`, `0x29 = 00`.
![Image alt](https://github.com/GearStarter/NierWemPatcher/blob/main/assets/bytes.png)
2. **Дополнение в оригинальных файлах**:
   - Оригинальные файлы .wem содержат в конце несколько последовательностей байтов `00 00`, отсутствующих в файлах, обработанных Wwise.
![Image alt](https://github.com/GearStarter/NierWemPatcher/blob/main/assets/zeros.png)

### Требования для успешного патчинга

Для обеспечения совместимости с NieR: Automata патченные файлы .wem должны соответствовать следующим условиям:

1. Общий размер нового файла .wem не должен превышать размер оригинального файла.
2. Длина аудиоданных не должна превышать длину оригинала, что можно проверить с помощью скрипта `check_wem_audio_length.py`.
3. Значения байтов на позициях `0x28` и `0x29` должны быть установлены в `0x28 = 04`, `0x29 = 00` с использованием скрипта `patch_wem.py`.
4. В конец файла .wem необходимо добавить последовательности байтов `00 00`, чтобы размер файла и длина данных соответствовали оригиналу, что выполняется с помощью скрипта `patch_wem.py`.

## Процесс работы

Типичный процесс замены аудиофайлов в NieR: Automata включает следующие шаги:

1. Распаковка архивов .wsp с использованием **NieR-Audio-Tools**.
2. Конвертация оригинальных файлов .wem в формат .wav для использования в качестве ориентира и подгонки звука.
3. Подготовка новых файлов .wav (48.0 kHz, Mono, 16 bits) для замены оригиналов.
4. Конвертация новых файлов .wav в формат .wem с использованием **Wwise 2016** (Vorbis Quality High, 48.0 kHz, Mono, Vorbis, Quality Level 4).
5. Патчинг файлов .wem для обеспечения совместимости с помощью предоставленных скриптов.
6. Упаковка патченных файлов .wem в архивы .wsp с использованием **NieR-Audio-Tools**.

## Инструкция по использованию

1. Поместите оригинальные файлы .wem в папку `orig`.
2. Поместите сконвертированные в Wwise файлы .wem в папку `converted`.
3. Проверьте длину аудиоданных с помощью скрипта `check_wem_audio_length.py`. При необходимости сократите длительность или снизьте битрейт аудиофайлов.
4. Примените патч к файлам .wem с помощью скрипта `patch_wem.py`. Готовые к упаковке файлы будут сохранены в папке `patched`.

## Инструменты

- `patch_wem.py`: Выполняет необходимые изменения байтов и добавляет дополнение в конец файлов .wem для соответствия структуре оригинальных файлов.
- `check_wem_audio_length.py`: Проверяет, что длина аудиоданных в сконвертированных файлах .wem не превышает длину оригиналов.
- `check_wem_bytes.py`: Этот скрипт проверяет .wem аудиофайлы в папке orig (или указанной папке) на корректные значения байтов на позициях `0x28 = 04` и `0x29 = 00`. Результаты записываются в invalid_wem_files.txt, где указаны проблемные файлы или подтверждение, что все файлы корректны.

## Дополнительные ресурсы

- Telegram: [ainyashaprime](https://t.me/ainyashaprime)
- Видео с демонстрацией: [YouTube](https://youtube.com/shorts/4wRLVO6P2VY?feature=share)